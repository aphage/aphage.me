{"componentChunkName":"component---src-templates-blog-post-js","path":"/Wow64-heaven's-gate-hook/","result":{"data":{"site":{"siteMetadata":{"title":"Hi, aphage"}},"markdownRemark":{"id":"4963b449-17b8-529a-8d76-95671f9c368a","excerpt":"什么是 Wow64 Wow64 是让 64 位的 Windows 可以运行 Win32 程序的兼容层，在 64 位系统上运行的 32 位程序 本质是一个 64 位程序 在操作系统安装目录中  就是 32 位程序的 runtime（运行时）库， 则是 64 位程序 runtime 库，在运行 Win3…","html":"<h2>什么是 Wow64</h2>\n<p>Wow64 是让 64 位的 Windows 可以运行 Win32 程序的兼容层，在 64 位系统上运行的 32 位程序 本质是一个 64 位程序</p>\n<p>在操作系统安装目录中 <code class=\"language-text\">Windows/SysWOW64</code> 就是 32 位程序的 runtime（运行时）库，<code class=\"language-text\">Windows/System32</code> 则是 64 位程序 runtime 库，在运行 Win32 程序时 <code class=\"language-text\">Windows/System32</code> 目录会被重定向到 <code class=\"language-text\">Windows/SysWOW64</code> 目录。</p>\n<h2>Wow64 是怎么调用系统 API 的呢</h2>\n<p>Wow64</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">77962C00 | B8 25000000              | mov eax,25                              | 25:&#39;%&#39;\n77962C05 | BA 50889777              | mov edx,ntdll.77978850                  |\n77962C0A | FFD2                     | call edx                                |\n77962C0C | C2 1400                  | ret 14                                  |</code></pre></div>\n<p>打开一个 Win32 程序，在 ntdll.dll 中可以看到是通过调用 edx 进行系统调用的，Win7 64 位应该是 <code class=\"language-text\">call dword ptr fs:[0xC0]</code> ，但是没关系他们都指向一个地方（是的没错，Wow 64 Gate 就保存在 <code class=\"language-text\">fs:[0xC0]</code> 中</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">7797884F | CC                       | int3                                    |\n77978850 | FF25 2892A177            | jmp dword ptr ds:[&lt;Wow64Transition&gt;]    |\n77978856 | CC                       | int3                                    |</code></pre></div>\n<p>可以看出字面意思 <code class=\"language-text\">Wow64Transition</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">778E7000 | EA 09708E77 3300         | jmp far 33:778E7009                     |</code></pre></div>\n<p>这条指令将 cs 段选择器设置为 0x33，从 32 位切换到 64 位模式，并跳转</p>\n<p>进入 Wow64 进行 API 翻译，之后通过调用指令进入内核，完成 API 调用</p>\n<h2>Wow64 Heaven’s Gate(天堂之门) Hook</h2>\n<p>现在我们知道 Wow64 Gate 地址保存在 <code class=\"language-text\">fs:[0xC0]</code> 中 ，在 TEB 结构中是 <code class=\"language-text\">WOW32Reserved</code> 成员</p>\n<p>完成后</p>\n<p><a href=\"https://github.com/aphage/wow64-gate-hook\">https://github.com/aphage/wow64-gate-hook</a></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1b0d98d0747091da13e48337d3bae144/c929c/procmon-view.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.59493670886076%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABJ0AAASdAHeZh94AAACRUlEQVQozz1TaY+TUBTt//8dkzgxmrjFGD/YjImOo3FSoUApLaVsQwt0pRS6eLznts5LTt5237nbeZ04TpDNMhyPR+z3eyyXS6xWK2y3WxwOBzRNI2if7+q6RtseBO31rtE7zrvdDp0oilGUJTabjT4IggCLxQKVXK7Xaz3jXNd7cTxDURQoxb682lRVhY0458xAOlykaaqERZ4jjiL1xMGoGREdcJzPZz3LsgzDoQvP8+D7PkajkeyHiOMYHYbKBaOYSQRc04jGJCNM04Rt23pPwkicWpalJITrunAcB9PpFB3mzzpeCOcIw0ijZTSn00kJ1+vNc8Ss65NEOBgMhNRWx3TGKBPJVAlnTwl2mxUW+RxpHGHsuSjzGfD3hGNTIw4DFPMMB1nLoe4HtiV2Q7UlXMdCNA1I2MAaR/CSEk6QwfBCfH+00HMDREWFyWyN7v0j7h56sCcpkmWDvp/gpzkUuIoHYyCQmgbXGr775ePNY4q3gpffPNx+dfD6foRP/RwfzBzvfwf44hT4bOf4aJV49cPHTdfE7Z2FF1fcdC3c2+El5SJLcG53ONZbzNMI1aqUgjWaHk4N2t2lhpdxQv4kZXFtRTCSdC1D1yydEoaixZUUfik68icT0VqJs3C1h6NorRadVUrFfS0lmgRTmH0LBrvvDNDr/YFhmIiTK2Fy1SGFGYah6ozdZaf5I6hDdphdJxJ5SJmwu+y2YRgqI34KrSH1Q/1xHo/Hatjv95WY2qMO+YBE/CkTyYKE/8VMXfKOwfwDZ7N318F0E/sAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"I am a image\"\n        title=\"I am a image\"\n        src=\"/static/1b0d98d0747091da13e48337d3bae144/f058b/procmon-view.png\"\n        srcset=\"/static/1b0d98d0747091da13e48337d3bae144/c26ae/procmon-view.png 158w,\n/static/1b0d98d0747091da13e48337d3bae144/6bdcf/procmon-view.png 315w,\n/static/1b0d98d0747091da13e48337d3bae144/f058b/procmon-view.png 630w,\n/static/1b0d98d0747091da13e48337d3bae144/40601/procmon-view.png 945w,\n/static/1b0d98d0747091da13e48337d3bae144/c929c/procmon-view.png 1218w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>资料</h2>\n<p><a href=\"https://en.wikipedia.org/wiki/WoW64\">WoW64 WiKi</a></p>\n<p><a href=\"http://rce.co/knockin-on-heavens-gate-dynamic-processor-mode-switching/\">Knockin’ on Heaven’s Gate – Dynamic Processor Mode Switching</a></p>\n<p><a href=\"https://www.fireeye.com/blog/threat-research/2020/11/wow64-subsystem-internals-and-hooking-techniques.html\">WOW64!Hooks: WOW64 Subsystem Internals and Hooking Techniques</a></p>\n<p><a href=\"https://zh.wikipedia.org/zh-hans/%E7%BA%BF%E7%A8%8B%E4%BF%A1%E6%81%AF%E5%9D%97\">线程信息块</a></p>","frontmatter":{"title":"Wow64 Heaven's Gate(天堂之门) Hook","date":"July 25, 2021","description":null}},"previous":{"fields":{"slug":"/arch-linux-installation/"},"frontmatter":{"title":"Arch Linux Installation"}},"next":null},"pageContext":{"id":"4963b449-17b8-529a-8d76-95671f9c368a","previousPostId":"1825343b-8e28-5a28-8738-7763844523bd","nextPostId":null}},"staticQueryHashes":["2241071305","2841359383"]}